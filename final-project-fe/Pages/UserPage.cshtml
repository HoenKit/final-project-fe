@page
@model final_project_fe.Pages.UserPageModel
@{
	ViewData["Title"] = "UserPage";
}
@{
	var token = HttpContext.Request.Cookies["AccessToken"];
}
<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="" />
	<meta name="keywords" content="" />
	<title>Winku Social Network Toolkit</title>
	<link rel="icon" href="images/fav.png" type="image/png" sizes="16x16">

	<link rel="stylesheet" href="css/main.min.css">
	<link rel="stylesheet" href="css/style.css">
	<link rel="stylesheet" href="css/color.css">
	<link rel="stylesheet" href="css/responsive.css">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

</head>
<body>
		<section>
			<div class="feature-photo">
				<figure><img src="images/resources/timeline-4.jpg" alt=""></figure>
				<div class="add-btn">
					<span>1.3k followers</span>
					<a href="#" title="" data-ripple="">Add button</a>
				</div>
				<form class="edit-phto">
					<i class="fa fa-camera-retro"></i>
					<label class="fileContainer">
						Edit Cover Photo
						<input type="file" />
					</label>
				</form>
				<div class="container-fluid">
					<div class="row merged">
						<div class="col-lg-2 col-sm-3">
							<div class="user-avatar">
								<figure>
									<img src="images/resources/user-avatar2.jpg" alt="">
									<form class="edit-phto">
										<i class="fa fa-camera-retro"></i>
										<label class="fileContainer">
											Edit Display Photo
											<input type="file" />
										</label>
									</form>
								</figure>
							</div>
						</div>
						<div class="col-lg-10 col-sm-9">
							<div class="timeline-info">
								<ul>
									<li class="admin-name">
										<h5>Amazon Shop</h5>
										@* <span>@amazonshop</span> *@
									</li>
									<li>
										<a class="active" asp-page="/UserPage" title="" data-ripple="">Page</a>
										<a class="" href="#" title="" data-ripple="">Notifications</a>
										<a class="" href="#" title="" data-ripple="">inbox</a>
										<a class="" href="#" title="" data-ripple="">insights</a>
										@* <a class="" href="fav-page.html" title="" data-ripple="">posts</a> *@
										<a class="" href="#" title="" data-ripple="">likers</a>
									</li>
								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>

		<section>
			<div class="gap gray-bg">
				<div class="container-fluid">
					<div class="row">
						<div class="col-lg-12">
							<div class="row" id="page-contents">
								<div class="col-lg-3">
									<aside class="sidebar static">
										<div class="widget">
											<h4 class="widget-title">Shortcuts</h4>
											<ul class="naves">
												<li>
													<i class="ti-clipboard"></i>
													<a asp-page="/Index" title="">News feed</a>
												</li>
											@* 	<li>
													<i class="ti-comments-smiley"></i>
													<a href="#" title="">Messages</a>
												</li>
												<li>
													<i class="ti-mouse-alt"></i>
													<a href="#" title="">Inbox</a>
												</li> 
												<li>
													<i class="ti-user"></i>
													<a href="#" title="">friends</a>
												</li> *@
												<li>
													<i class="ti-image"></i>
													<a href="#" title="">images</a>
												</li>
												<li>
													<i class="ti-video-camera"></i>
													<a href="#" title="">videos</a>
												</li>
												<li>
													<i class="ti-bell"></i>
													<a href="#" title="">Notifications</a>
												</li>
											</ul>
										</div><!-- Shortcuts -->
										<div class="widget">
											<h4 class="widget-title">Recent Activity</h4>
											<ul class="activitiez">
												<li>
													<div class="activity-meta">
														<i>10 hours Ago</i>
														<span><a href="#" title="">Commented on Video posted </a></span>
														<h6>by <a href="time-line.html">black demon.</a></h6>
													</div>
												</li>
												<li>
													<div class="activity-meta">
														<i>30 Days Ago</i>
														<span><a href="#" title="">Posted your status. “Hello guys, how are you?”</a></span>
													</div>
												</li>
												<li>
													<div class="activity-meta">
														<i>2 Years Ago</i>
														<span><a href="#" title="">Share a video on her timeline.</a></span>
														<h6>"<a href="#">you are so funny mr.been.</a>"</h6>
													</div>
												</li>
											</ul>
										</div><!-- recent activites -->
										<div class="widget stick-widget">
											<h4 class="widget-title">Who's follownig</h4>
											<ul class="followers">
												<li>
													<figure><img src="images/resources/friend-avatar2.jpg" alt=""></figure>
													<div class="friend-meta">
														<h4><a href="time-line.html" title="">Kelly Bill</a></h4>
														<a href="#" title="" class="underline">Add Friend</a>
													</div>
												</li>
												<li>
													<figure><img src="images/resources/friend-avatar4.jpg" alt=""></figure>
													<div class="friend-meta">
														<h4><a href="time-line.html" title="">Issabel</a></h4>
														<a href="#" title="" class="underline">Add Friend</a>
													</div>
												</li>
												<li>
													<figure><img src="images/resources/friend-avatar6.jpg" alt=""></figure>
													<div class="friend-meta">
														<h4><a href="time-line.html" title="">Andrew</a></h4>
														<a href="#" title="" class="underline">Add Friend</a>
													</div>
												</li>
												<li>
													<figure><img src="images/resources/friend-avatar8.jpg" alt=""></figure>
													<div class="friend-meta">
														<h4><a href="time-line.html" title="">Sophia</a></h4>
														<a href="#" title="" class="underline">Add Friend</a>
													</div>
												</li>
												<li>
													<figure><img src="images/resources/friend-avatar3.jpg" alt=""></figure>
													<div class="friend-meta">
														<h4><a href="time-line.html" title="">Allen</a></h4>
														<a href="#" title="" class="underline">Add Friend</a>
													</div>
												</li>
											</ul>
										</div><!-- who's following -->
									</aside>
								</div><!-- sidebar -->
								<div class="col-lg-6">
		@* 									<form method="post">
												<div class="form-group">
													<input asp-for="NewPost.Title" type="text" placeholder="Enter Post Title" class="form-control" required />
												</div>

												<div class="form-group">
													<textarea asp-for="NewPost.Content" rows="3" placeholder="Write something..." class="form-control" required></textarea>
												</div>
												<div class="attachments">
													<ul>
														<li>
															<i class="fa fa-music"></i>
															<label class="fileContainer">
																<input type="file" />
															</label>
														</li>
														<li>
															<i class="fa fa-image"></i>
															<label class="fileContainer">
																<input type="file" />
															</label>
														</li>
														<li>
															<i class="fa fa-video-camera"></i>
															<label class="fileContainer">
																<input type="file" />
															</label>
														</li>
														<li>
															<i class="fa fa-camera"></i>
															<label class="fileContainer">
																<input type="file" />
															</label>
														</li>
														<button type="submit" class="btn btn-primary">Publish</button>
													</ul>
												</div>
											</form>
										</div>
										</div>
									</div> *@
									<!-- add post new box -->
									<div class="loadMore">
										<div class="central-meta item">
											<div class="user-post">
													@if (Model.Posts != null && Model.Posts.Items.Any())
													{
														<ul>
															@foreach (var post in Model.Posts.Items.OrderByDescending(p => p.CreateAt))
															{
																<li>
																	<div class="friend-info">
																		<figure>
																			<img src="@(string.IsNullOrEmpty(post.User?.UserMetaData?.Avatar) ? "images/resources/friend-avatar9.jpg" : post.User?.UserMetaData.Avatar)"
																				 alt="User Avatar">

																		</figure>

																		<div class="post-meta">
																			<p style="font-size: 20px; font-weight: bold; color: black; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);">
																				@post.Title
																			</p>
																		</div>


																		<div class="friend-name">
																			<ins>
																				<a href="time-line.html" title="">
																					@((post.User?.UserMetaData != null)
																																					? $"{post.User.UserMetaData.FirstName} {post.User.UserMetaData.LastName}"
																																					: post.User?.Email)
																				</a>
																			</ins>
																			<span>@post.CreateAt.ToString("dd/MM/yyyy HH:mm")</span>
																		</div>

																		<div class="post-meta">
																			@* 	@if (Model.PostFilesByPost.ContainsKey(post.PostId) && Model.PostFilesByPost[post.PostId].Any(f => f.PostFileType.ToLower() == "image" || f.PostFileType.ToLower() == "video"))
																		{
																			@foreach (var file in Model.PostFilesByPost[post.PostId])
																			{
																				@if (file.PostFileType.ToLower() == "image")
																				{
																					<img src="@file.FileUrl" alt="Post Image" width="400" />
																				}
																				else if (file.PostFileType.ToLower() == "video")
																				{
																					<iframe src="@file.FileUrl" height="315" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>
																				}
																			}
																		} *@
																			@* 	else
																		{
																			<img src="https://toigingiuvedep.vn/wp-content/uploads/2021/06/hinh-anh-bau-troi-dem-day-sao-tuyet-dep-cho-may-tinh.jpg"
																				 alt="Default Post Image" width="400" />
																		} *@

																			@if (post.PostFiles != null && post.PostFiles.Any())
																			{
																				foreach (var postFile in post.PostFiles)
																				{
																					if (postFile.PostFileType.ToLower() == "image")
																					{
																						<img src="@postFile.FileUrl" alt="Post Image" width="400" />
																					}
																					else
																					{
																						<iframe src="@postFile.FileUrl" height="315" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>
																					}
																				}
																			}

																			<div class="description">
																				<p>@post.Content</p>
																			</div>
																		</div>

																		<!-- Comment section -->
																		<div class="comments-section" id="commentList-@post.PostId">
																			@if (Model.CommentsByPost.ContainsKey(post.PostId))
																			{
																				var comments = Model.CommentsByPost[post.PostId];
																				@foreach (var comment in comments)

																				@*@if (post.Comments != null && post.Comments.Any()) // Kiểm tra nếu có comment
																		{
																			foreach (var comment in post.Comments)*@
																				{
																					var isReply = comment.ParentCommentId != null;
																					var commentClass = isReply ? "comment reply-comment" : "comment";

																					<div class="@commentClass" data-comment-id="@comment.CommentId">
																						<div class="comet-avatar">
																							<img src="@(string.IsNullOrEmpty(comment.User?.UserMetaData?.Avatar) ? "images/resources/friend-avatar9.jpg" : comment.User?.UserMetaData.Avatar)"
																								 alt="User Avatar">
																						</div>
																						<div class="we-comment">
																							<div class="coment-head">
																								<h5>
																									<a href="time-line.html" title="">
																										@((comment.User?.UserMetaData != null)
																																													? $"{comment.User.UserMetaData.FirstName} {comment.User.UserMetaData.LastName}"
																																													: comment.User?.Email)
																									</a>
																								</h5>
																								<span>@comment.CreateAt.ToString("dd/MM/yyyy HH:mm")</span>
																								@if (!string.IsNullOrEmpty(token))

																								{
																									<a class="we-reply" href="javascript:void(0)" data-reply-to="@comment.CommentId" title="Reply">
																										<i class="fa fa-reply"></i>
																									</a>
																								}
																							</div>
																							<p>@comment.Content</p>
																							@if (!string.IsNullOrEmpty(token))

																							{
																								<!-- Form trả lời ẩn -->
																								<div class="reply-form" style="display: none; margin-top: 10px;">
																									<form class="comment-form">
																										<input type="hidden" name="NewComment.PostId" value="@post.PostId" />
																										<input type="hidden" name="NewComment.ParentCommentId" value="@comment.CommentId" />
																										<textarea name="NewComment.Content" placeholder="Write a reply..."></textarea>
																										<button type="submit" class="btn btn-sm btn-primary mt-1">Send</button>
																									</form>
																								</div>

																							}
																						</div>
																					</div>
																				}
																			}
																			else
																			{
																				<p>No Comment available.</p>
																			}
																		</div>

																		<!-- Comment input form -->
																		@if (!string.IsNullOrEmpty(token))
																		{
																			<!-- Comment input form -->
																			<div class="coment-area">
																				<ul class="we-comet">
																					<li class="post-comment">
																						<div class="comet-avatar">
																							<img src="images/resources/friend-avatar9.jpg" alt="User Avatar">
																						</div>
																						<div class="post-comt-box">
																							<form class="comment-form">
																								<input type="hidden" name="NewComment.PostId" value="@post.PostId" />
																								<input type="hidden" name="NewComment.ParentCommentId" />
																								<label>Comment:</label>
																								<textarea name="NewComment.Content" placeholder="Write a comment..."></textarea>
																								<button type="submit" class="bi bi-send" style="font-size: 24px; color: black;"></button>
																							</form>
																						</div>
																					</li>
																				</ul>
																			</div>
																		}
																	</div>
																</li>
															}

														</ul>

														<p>Page @Model.Posts.CurrentPage / @Model.Posts.TotalPages</p>

													}
													else
													{
														<p>No posts available.</p>
													}

												</div>
											</div>
										</div>
									</div>
									<div class="col-lg-3">
										<aside class="sidebar static">
											<div class="advertisment-box">
												<h4 class="">advertisment</h4>
												<figure>
													<a href="#" title="Advertisment"><img src="images/resources/ad-widget.jpg" alt=""></a>
												</figure>
											</div>
											<div class="widget">
												<h4 class="widget-title">Invite friends</h4>
												<ul class="invition">
													<li>
														<figure><img src="images/resources/friend-avatar8.jpg" alt=""></figure>
														<div class="friend-meta">
															<h4><a href="time-line.html" class="underline" title="">Sophia hayat</a></h4>
															<a href="#" title="" class="invite" data-ripple="">invite</a>
														</div>
													</li>
													<li>
														<figure><img src="images/resources/friend-avatar4.jpg" alt=""></figure>
														<div class="friend-meta">
															<h4><a href="time-line.html" class="underline" title="">Issabel kaif</a></h4>
															<a href="#" title="" class="invite" data-ripple="">invite</a>
														</div>
													</li>
													<li>
														<figure><img src="images/resources/friend-avatar2.jpg" alt=""></figure>
														<div class="friend-meta">
															<h4><a href="time-line.html" class="underline" title="">Kelly Bill</a></h4>
															<a href="#" title="" class="invite" data-ripple="">invite</a>
														</div>
													</li>
													<li>
														<figure><img src="images/resources/friend-avatar3.jpg" alt=""></figure>
														<div class="friend-meta">
															<h4><a href="time-line.html" class="underline" title="">Allen jhon</a></h4>
															<a href="#" title="" class="invite" data-ripple="">invite</a>
														</div>
													</li>
													<li>
														<figure><img src="images/resources/friend-avatar6.jpg" alt=""></figure>
														<div class="friend-meta">
															<h4><a href="time-line.html" class="underline" title="">tom Andrew</a></h4>
															<a href="#" title="" class="invite" data-ripple="">invite</a>
														</div>
													</li>

													<li>
														<figure><img src="images/resources/friend-avatar3.jpg" alt=""></figure>
														<div class="friend-meta">
															<h4><a href="time-line.html" title="" class="underline">Allen doe</a></h4>
															<a href="#" title="" class="invite" data-ripple="">invite</a>
														</div>
													</li>
												</ul>
											</div><!-- invite for page  -->

											<div class="widget friend-list stick-widget">
												<h4 class="widget-title">Friends</h4>
												<div id="searchDir"></div>
												<ul id="people-list" class="friendz-list">
													<li>
														<figure>
															<img src="images/resources/friend-avatar.jpg" alt="">
															<span class="status f-online"></span>
														</figure>
														<div class="friendz-meta">
															<a href="time-line.html">bucky barnes</a>
															<i><a href="https://wpkixx.com/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="1e6977706a7b6c6d71727a7b6c5e79737f7772307d7173">[email&#160;protected]</a></i>
														</div>
													</li>
													<li>
														<figure>
															<img src="images/resources/friend-avatar2.jpg" alt="">
															<span class="status f-away"></span>
														</figure>
														<div class="friendz-meta">
															<a href="time-line.html">Sarah Loren</a>
															<i><a href="https://wpkixx.com/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="debcbfacb0bbad9eb9b3bfb7b2f0bdb1b3">[email&#160;protected]</a></i>
														</div>
													</li>
													<li>
														<figure>
															<img src="images/resources/friend-avatar3.jpg" alt="">
															<span class="status f-off"></span>
														</figure>
														<div class="friendz-meta">
															<a href="time-line.html">jason borne</a>
															<i><a href="https://wpkixx.com/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="0e646f7d61606c4e69636f6762206d6163">[email&#160;protected]</a></i>
														</div>
													</li>
													<li>
														<figure>
															<img src="images/resources/friend-avatar4.jpg" alt="">
															<span class="status f-off"></span>
														</figure>
														<div class="friendz-meta">
															<a href="time-line.html">Cameron diaz</a>
															<i><a href="https://wpkixx.com/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="513b30223e3f3311363c30383d7f323e3c">[email&#160;protected]</a></i>
														</div>
													</li>
													<li>

														<figure>
															<img src="images/resources/friend-avatar5.jpg" alt="">
															<span class="status f-online"></span>
														</figure>
														<div class="friendz-meta">
															<a href="time-line.html">daniel warber</a>
															<i><a href="https://wpkixx.com/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="315b50425e5f5371565c50585d1f525e5c">[email&#160;protected]</a></i>
														</div>
													</li>
													<li>

														<figure>
															<img src="images/resources/friend-avatar6.jpg" alt="">
															<span class="status f-away"></span>
														</figure>
														<div class="friendz-meta">
															<a href="time-line.html">andrew</a>
															<i><a href="https://wpkixx.com/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="f69c9785999894b6919b979f9ad895999b">[email&#160;protected]</a></i>
														</div>
													</li>
													<li>

														<figure>
															<img src="images/resources/friend-avatar7.jpg" alt="">
															<span class="status f-off"></span>
														</figure>
														<div class="friendz-meta">
															<a href="time-line.html">amy watson</a>
															<i><a href="https://wpkixx.com/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="bad0dbc9d5d4d8faddd7dbd3d694d9d5d7">[email&#160;protected]</a></i>
														</div>
													</li>
													<li>

														<figure>
															<img src="images/resources/friend-avatar5.jpg" alt="">
															<span class="status f-online"></span>
														</figure>
														<div class="friendz-meta">
															<a href="time-line.html">daniel warber</a>
															<i><a href="https://wpkixx.com/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="076d667468696547606a666e6b2964686a">[email&#160;protected]</a></i>
														</div>
													</li>
													<li>

														<figure>
															<img src="images/resources/friend-avatar2.jpg" alt="">
															<span class="status f-away"></span>
														</figure>
														<div class="friendz-meta">
															<a href="time-line.html">Sarah Loren</a>
															<i><a href="https://wpkixx.com/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="b1d3d0c3dfd4c2f1d6dcd0d8dd9fd2dedc">[email&#160;protected]</a></i>
														</div>
													</li>
												</ul>
												<div class="chat-box">
													<div class="chat-head">
														<span class="status f-online"></span>
														<h6>Bucky Barnes</h6>
														<div class="more">
															<span><i class="ti-more-alt"></i></span>
															<span class="close-mesage"><i class="ti-close"></i></span>
														</div>
													</div>
													<div class="chat-list">
														<ul>
															<li class="me">
																<div class="chat-thumb"><img src="images/resources/chatlist1.jpg" alt=""></div>
																<div class="notification-event">
																	<span class="chat-message-item">
																		Hi James! Please remember to buy the food for tomorrow! I’m gonna be handling the gifts and Jake’s gonna get the drinks
																	</span>
																	<span class="notification-date"><time datetime="2004-07-24T18:18" class="entry-date updated">Yesterday at 8:10pm</time></span>
																</div>
															</li>
															<li class="you">
																<div class="chat-thumb"><img src="images/resources/chatlist2.jpg" alt=""></div>
																<div class="notification-event">
																	<span class="chat-message-item">
																		Hi James! Please remember to buy the food for tomorrow! I’m gonna be handling the gifts and Jake’s gonna get the drinks
																	</span>
																	<span class="notification-date"><time datetime="2004-07-24T18:18" class="entry-date updated">Yesterday at 8:10pm</time></span>
																</div>
															</li>
															<li class="me">
																<div class="chat-thumb"><img src="images/resources/chatlist1.jpg" alt=""></div>
																<div class="notification-event">
																	<span class="chat-message-item">
																		Hi James! Please remember to buy the food for tomorrow! I’m gonna be handling the gifts and Jake’s gonna get the drinks
																	</span>
																	<span class="notification-date"><time datetime="2004-07-24T18:18" class="entry-date updated">Yesterday at 8:10pm</time></span>
																</div>
															</li>
														</ul>
														<form class="text-box">
															<textarea placeholder="Post enter to post..."></textarea>
															<div class="add-smiles">
																<span title="add icon" class="em em-expressionless"></span>
															</div>
															<div class="smiles-bunch">
																<i class="em em---1"></i>
																<i class="em em-smiley"></i>
																<i class="em em-anguished"></i>
																<i class="em em-laughing"></i>
																<i class="em em-angry"></i>
																<i class="em em-astonished"></i>
																<i class="em em-blush"></i>
																<i class="em em-disappointed"></i>
																<i class="em em-worried"></i>
																<i class="em em-kissing_heart"></i>
																<i class="em em-rage"></i>
																<i class="em em-stuck_out_tongue"></i>
															</div>
															<button type="submit"></button>
														</form>
													</div>
												</div>
											</div><!-- friends list sidebar -->
										</aside>
									</div><!-- sidebar -->
								</div>
							</div>
						</div>
					</div>
				</div>
		</section>
		<div class="bottombar">
			<div class="container">
				<div class="row">
					<div class="col-md-12">
						<span class="copyright"><a target="_blank" href="https://www.templateshub.net">Templates Hub</a></span>
						<i><img src="images/credit-cards.png" alt=""></i>
					</div>
				</div>
			</div>
		</div>

	<script data-cfasync="false" src="../../cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
	<script src="js/main.min.js"></script>
	<script src="js/script.js"></script>
	<script src="js/map-init.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
	<script>
		currentUserId = '@Model.CurrentUserId';
		document.addEventListener('DOMContentLoaded', () => {
		  const HubUrl  = "@Model.HubUrl";
		  const BaseUrl = "@Model.BaseUrl";
		  const userId  = currentUserId;

		  // Hiển thị thông tin kết nối để debug
		  console.log("Connecting to SignalR hub:", HubUrl);
		  console.log("Base API URL:", BaseUrl);
		  console.log("Current User ID:", userId);

		  const connection = new signalR.HubConnectionBuilder()
			.withUrl(`${HubUrl}/postHub`)
			.withAutomaticReconnect() // Thêm tự động kết nối lại
			.build();

		  async function getUserInfo(id) {
			const defaultAvatar = "images/resources/friend-avatar9.jpg";
			const defaultName   = "Unknown User";
			if (!id) return { avatar: defaultAvatar, name: defaultName };

			try {
			  const res = await fetch(`${BaseUrl}/UserManager/${id}`, { credentials: 'include' });
			  if (res.ok) {
				const u = await res.json();
				return {
				  avatar: u?.userMetaData?.avatar || defaultAvatar,
				  name:   u?.userMetaData
							? `${u.userMetaData.firstName} ${u.userMetaData.lastName}`
							: u.email || defaultName
				};
			  }
			} catch (error) {
			  console.error("Error fetching user info:", error);
			}
			return { avatar: defaultAvatar, name: defaultName };
		  }

		  function createPostHtml(post, avatar, name) {
			const d = new Date(post.createAt).toLocaleString();

			// Handle file attachments (images and videos)
			let mediaContent = '';
			if (post.files && post.files.length > 0) {
			  post.files.forEach(file => {
				if (file.postFileType?.toLowerCase() === "image") {
				  mediaContent += `<img src="${file.fileUrl}" alt="Post Image" width="400" />`;
				} else if (file.postFileType?.toLowerCase() === "video") {
				  mediaContent += `<iframe src="${file.fileUrl}" height="315" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>`;
				}
			  });
			}

			return `
			  <li id="post-${post.postId}">
				<div class="friend-info">
				  <figure>
					<img src="${avatar}" alt="User Avatar">
				  </figure>
				  <div class="post-meta">
					<p style="font-size: 20px; font-weight: bold; color: black; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);">
					  ${post.title}
					</p>
				  </div>
				  <div class="friend-name">
					<ins><a href="time-line.html" title="">${name}</a></ins>
					<span>${d}</span>
				  </div>
				  <div class="post-meta">
					${mediaContent}
					<div class="description">
					  <p>${post.content}</p>
					</div>
				  </div>
				  <div class="comments-section" id="commentList-${post.postId}"></div>
				  <div class="coment-area">
					<ul class="we-comet">
					  <li class="post-comment">
						<div class="comet-avatar">
						  <img src="images/resources/friend-avatar9.jpg" alt="User Avatar">
						</div>
						<div class="post-comt-box">
						  <form class="comment-form">
							<input type="hidden" name="NewComment.PostId" value="${post.postId}">
							<input type="hidden" name="NewComment.ParentCommentId">
							<textarea name="NewComment.Content" placeholder="Write a reply..."></textarea>
							<button type="submit" class="bi bi-send" style="font-size: 24px; color: black;"></button>
						  </form>
						</div>
					  </li>
					</ul>
				  </div>
				</div>
			  </li>`;
		  }

		  function createCommentHtml(comment, avatar, name) {
			const isReply = comment.parentCommentId != null;
			const cls = isReply ? "comment reply-comment" : "comment";
			const date = new Date(comment.createAt);

			const formattedDate = date.toLocaleDateString("vi-VN");
			const formattedTime = date.toLocaleTimeString("vi-VN", {
			  hour: "2-digit",
			  minute: "2-digit"
			});

			const d = `${formattedDate} ${formattedTime}`;

			return `
			  <div class="${cls}" data-comment-id="${comment.commentId}" data-parent-id="${comment.parentCommentId || ''}">
				<div class="comet-avatar">
				  <img src="${avatar}" alt="User Avatar">
				</div>
				<div class="we-comment">
				  <div class="coment-head">
					<h5>
					  <a href="time-line.html" title="">${name}</a>
					</h5>
					<span>${d}</span>
					<a class="we-reply" href="javascript:void(0)" data-reply-to="${comment.commentId}" title="Reply">
					  <i class="fa fa-reply"></i>
					</a>
				  </div>
				  <p>${comment.content}</p>
				  <!-- Form trả lời ẩn -->
				  <div class="reply-form" style="display: none; margin-top: 10px;">
					<form class="comment-form">
					  <input type="hidden" name="NewComment.PostId" value="${comment.postId}" />
					  <input type="hidden" name="NewComment.ParentCommentId" value="${comment.commentId}" />
					  <textarea name="NewComment.Content" placeholder="Write a reply..."></textarea>
					  <button type="submit" class="btn btn-sm btn-primary mt-1">Send</button>
					</form>
				  </div>
				</div>
			  </div>`;
		  }

		  // Nhận post từ SignalR
		  connection.on("ReceivePost", async post => {
			console.log("Received post:", post);
			const { avatar, name } = await getUserInfo(post.userId);
			const postList = document.querySelector("#post-list");
			if (postList) {
			  // Thêm post mới vào đầu danh sách
			  postList.insertAdjacentHTML("afterbegin", createPostHtml(post, avatar, name));
			  console.log("Post added to DOM at the beginning of list");
			} else {
			  console.error("Element #post-list not found");
			}
		  });

		  // Nhận comment từ SignalR
		  connection.on("ReceiveComment", async comment => {
			console.log("Received comment:", comment);
			const { avatar, name } = await getUserInfo(comment.userId);

			if (comment.parentCommentId) {
			  // Đây là reply - thêm vào sau comment cha
			  const parentComment = document.querySelector(`[data-comment-id="${comment.parentCommentId}"]`);
			  if (parentComment) {
				// Tìm vị trí để chèn reply
				let nextElement = parentComment.nextElementSibling;
				// Nếu phần tử tiếp theo không phải là reply hoặc là reply của comment khác,
				// thì chèn ngay sau comment cha
				if (!nextElement ||
					!nextElement.classList.contains('reply-comment') ||
					nextElement.getAttribute('data-parent-id') !== comment.parentCommentId) {
				  parentComment.insertAdjacentHTML("afterend", createCommentHtml(comment, avatar, name));
				} else {
				  // Nếu đã có reply, tìm reply cuối cùng trong nhóm
				  while (nextElement &&
						 nextElement.classList.contains('reply-comment') &&
						 nextElement.getAttribute('data-parent-id') === comment.parentCommentId) {
					const temp = nextElement.nextElementSibling;
					if (!temp ||
						!temp.classList.contains('reply-comment') ||
						temp.getAttribute('data-parent-id') !== comment.parentCommentId) {
					  break;
					}
					nextElement = temp;
				  }
				  // Chèn sau reply cuối cùng
				  nextElement.insertAdjacentHTML("afterend", createCommentHtml(comment, avatar, name));
				}
				console.log("Reply added after parent comment");
			  } else {
				console.error(`Parent comment with ID ${comment.parentCommentId} not found`);
			  }
			} else {
			  // Đây là comment gốc - thêm vào đầu danh sách comments
			  const commentList = document.querySelector(`#commentList-${comment.postId}`);
			  if (commentList) {
				commentList.insertAdjacentHTML("afterbegin", createCommentHtml(comment, avatar, name));
				console.log("Comment added to the beginning of comment list");
			  } else {
				console.error(`Element #commentList-${comment.postId} not found`);
			  }
			}
		  });

		  // Xử lý kết nối SignalR
		  connection.start()
			.then(() => {
			  console.log("SignalR connected successfully");
			})
			.catch(err => {
			  console.error("SignalR connection error:", err);
			  // Thử kết nối lại sau 5 giây
			  setTimeout(() => connection.start(), 5000);
			});

		  // Handle connection events
		  connection.onclose(error => {
			console.log("SignalR connection closed, attempting to reconnect...");
		  });

		  connection.onreconnecting(error => {
			console.log("SignalR reconnecting...", error);
		  });

		  connection.onreconnected(connectionId => {
			console.log("SignalR reconnected. ConnectionId:", connectionId);
		  });

		  // Xử lý sự kiện click nút reply
		  document.body.addEventListener('click', e => {
			const btn = e.target.closest('.we-reply');
			if (!btn) return;
			e.preventDefault();
			const id = btn.getAttribute('data-reply-to');
			const form = document.querySelector(`.comment[data-comment-id="${id}"] .reply-form`);
			if (form) form.style.display = form.style.display === 'none' ? 'block' : 'none';
		  });

		  // Xử lý sự kiện submit form comment
		  document.body.addEventListener('submit', async e => {
			const form = e.target.closest('form.comment-form');
			const replyform = e.target.closest('.reply-form')
			if (!form) return;
			e.preventDefault();

			const fm = new FormData(form);
			const payload = {
			  postId: Number(fm.get('NewComment.PostId')),
			  parentCommentId: fm.get('NewComment.ParentCommentId')
							? Number(fm.get('NewComment.ParentCommentId'))
							: null,
			  content: fm.get('NewComment.Content').trim(),
			  userId: currentUserId
			};

			if (!payload.content) return;
			console.log("Submitting comment:", payload);

			try {
			  const res = await fetch(`${BaseUrl}/Comment`, {
				method: 'POST',
				credentials: 'include',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(payload)
			  });

			  if (!res.ok) {
				const errorText = await res.text();
				console.error('Post comment failed:', errorText);
				alert('Comment could not be submitted. Please try again later.');
				return;
			  }

			  console.log("Comment posted successfully");
			  form.reset();
			  if (replyform) replyform.style.display = 'none';
			} catch (error) {
			  console.error("Error posting comment:", error);
			  alert('An error occurred while submitting the comment.');
			}
		  });

		  // Thêm form tạo post mới (nếu cần)
		  document.body.addEventListener('submit', async e => {
			const form = e.target.closest('form.post-form');
			if (!form) return;
			e.preventDefault();

			const fm = new FormData(form);
			const payload = {
			  title: fm.get('NewPost.Title').trim(),
			  content: fm.get('NewPost.Content').trim(),
			  userId: currentUserId
			};

			if (!payload.title || !payload.content) return;
			console.log("Submitting post:", payload);

			try {
			  const res = await fetch(`${BaseUrl}/Post`, {
				method: 'POST',
				credentials: 'include',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(payload)
			  });

			  if (!res.ok) {
				const errorText = await res.text();
				console.error('Post creation failed:', errorText);
				alert('Không thể tạo bài viết. Vui lòng thử lại sau.');
				return;
			  }

			  console.log("Post created successfully");
			  form.reset();
			} catch (error) {
			  console.error("Error creating post:", error);
			  alert('Đã xảy ra lỗi khi tạo bài viết.');
			}
		  });
		});
	</script>


	<style>
		.comments-section .comment {
			margin-bottom: 20px; /* Tạo khoảng cách giữa các comment */
			padding-bottom: 10px; /* Tạo khoảng cách phía dưới comment */
			border-bottom: 1px solid #ddd; /* Thêm một đường phân cách giữa các comment */
		}

			.comments-section .comment.reply-comment {
				margin-left: 40px; /* Thụt vào cho các reply */
				border-left: 2px solid #ccc; /* Đường viền phân biệt reply */
				padding-left: 10px;
			}

		.coment-area {
			margin-top: 20px;
		}

			.coment-area .post-comt-box {
				margin-top: 10px;
			}

				.coment-area .post-comt-box textarea {
					width: 100%;
					height: 100px;
					padding: 10px;
					border: 1px solid #ddd;
					border-radius: 5px;
				}
	</style>

</body>


</html>