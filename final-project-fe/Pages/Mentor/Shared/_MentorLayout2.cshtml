@using System.IdentityModel.Tokens.Jwt
@using System.Security.Claims
@using final_project_fe.Utils
@using Microsoft.Extensions.Options
@inject IOptions<ApiSettings> ApiSettings
@inject IOptions<SignalrSetting> SignalrSetting

@{
    var roles = new List<string>();
    var token = Context.Request.Cookies["AccessToken"];
    bool isAuthenticated = !string.IsNullOrEmpty(token);
    Guid? userId = null;
    var BaseUrl = ApiSettings.Value.BaseUrl;
    var HubUrl = SignalrSetting.Value.HubUrl;

    if (!string.IsNullOrEmpty(token))
    {
        var handler = new JwtSecurityTokenHandler();
        var jwtToken = handler.ReadJwtToken(token);

        // Lấy claim UserId
        var userIdClaim = jwtToken.Claims.FirstOrDefault(c => c.Type == ClaimTypes.NameIdentifier);
        if (userIdClaim != null && Guid.TryParse(userIdClaim.Value, out var parsedId))
        {
            userId = parsedId;
        }

        // Nếu muốn lấy roles từ token
        roles = jwtToken.Claims
                        .Where(c => c.Type == ClaimTypes.Role)
                        .Select(c => c.Value)
                        .ToList();
    }
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <!-- ========== All CSS files linkup ========= -->
    <link rel="stylesheet" href=@Url.Content("~/MentorAssets/css/bootstrap.min.css") />
    <link rel="icon" type="image/x-icon" href="~/images/fav_icon.png" />
    <link rel="stylesheet" href=@Url.Content("~/MentorAssets/css/materialdesignicons.min.css") rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href=@Url.Content("~/MentorAssets/css/main.css") />
</head>
<body>
    <!-- ======== Preloader =========== -->
    <div id="preloader">
        <div class="spinner"></div>
    </div>
    <!-- ======== Preloader =========== -->
    <!-- ======== sidebar-nav start =========== -->
    <aside class="sidebar-nav-wrapper">
        <div class="navbar-logo">
            <a title="" asp-page="/Index"><img style="width:85%;" src="~/images/Logoda.png" alt=""></a>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li class="nav-item">
                    <a asp-page="Dashboard">
                        <span class="icon">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8.74999 18.3333C12.2376 18.3333 15.1364 15.8128 15.7244 12.4941C15.8448 11.8143 15.2737 11.25 14.5833 11.25H9.99999C9.30966 11.25 8.74999 10.6903 8.74999 10V5.41666C8.74999 4.7263 8.18563 4.15512 7.50586 4.27556C4.18711 4.86357 1.66666 7.76243 1.66666 11.25C1.66666 15.162 4.83797 18.3333 8.74999 18.3333Z" />
                                <path d="M17.0833 10C17.7737 10 18.3432 9.43708 18.2408 8.75433C17.7005 5.14918 14.8508 2.29947 11.2457 1.75912C10.5629 1.6568 10 2.2263 10 2.91665V9.16666C10 9.62691 10.3731 10 10.8333 10H17.0833Z" />
                            </svg>
                        </span>
                        <span class="text">Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a asp-page="MyCourses">
                        <span class="icon">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M11.8097 1.66667C11.8315 1.66667 11.8533 1.6671 11.875 1.66796V4.16667C11.875 5.43232 12.901 6.45834 14.1667 6.45834H16.6654C16.6663 6.48007 16.6667 6.50186 16.6667 6.5237V16.6667C16.6667 17.5872 15.9205 18.3333 15 18.3333H5.00001C4.07954 18.3333 3.33334 17.5872 3.33334 16.6667V3.33334C3.33334 2.41286 4.07954 1.66667 5.00001 1.66667H11.8097ZM6.66668 7.70834C6.3215 7.70834 6.04168 7.98816 6.04168 8.33334C6.04168 8.67851 6.3215 8.95834 6.66668 8.95834H10C10.3452 8.95834 10.625 8.67851 10.625 8.33334C10.625 7.98816 10.3452 7.70834 10 7.70834H6.66668ZM6.04168 11.6667C6.04168 12.0118 6.3215 12.2917 6.66668 12.2917H13.3333C13.6785 12.2917 13.9583 12.0118 13.9583 11.6667C13.9583 11.3215 13.6785 11.0417 13.3333 11.0417H6.66668C6.3215 11.0417 6.04168 11.3215 6.04168 11.6667ZM6.66668 14.375C6.3215 14.375 6.04168 14.6548 6.04168 15C6.04168 15.3452 6.3215 15.625 6.66668 15.625H13.3333C13.6785 15.625 13.9583 15.3452 13.9583 15C13.9583 14.6548 13.6785 14.375 13.3333 14.375H6.66668Z" />
                                <path d="M13.125 2.29167L16.0417 5.20834H14.1667C13.5913 5.20834 13.125 4.74197 13.125 4.16667V2.29167Z" />
                            </svg>
                        </span>
                        <span class="text">My Courses</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a asp-page="RequestWithdrawal">
                        <span class="icon">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3.33334 3.35442C3.33334 2.4223 4.07954 1.66666 5.00001 1.66666H15C15.9205 1.66666 16.6667 2.4223 16.6667 3.35442V16.8565C16.6667 17.5519 15.8827 17.9489 15.3333 17.5317L13.8333 16.3924C13.537 16.1673 13.1297 16.1673 12.8333 16.3924L10.5 18.1646C10.2037 18.3896 9.79634 18.3896 9.50001 18.1646L7.16668 16.3924C6.87038 16.1673 6.46298 16.1673 6.16668 16.3924L4.66668 17.5317C4.11731 17.9489 3.33334 17.5519 3.33334 16.8565V3.35442ZM4.79168 5.04218C4.79168 5.39173 5.0715 5.6751 5.41668 5.6751H10C10.3452 5.6751 10.625 5.39173 10.625 5.04218C10.625 4.69264 10.3452 4.40927 10 4.40927H5.41668C5.0715 4.40927 4.79168 4.69264 4.79168 5.04218ZM5.41668 7.7848C5.0715 7.7848 4.79168 8.06817 4.79168 8.41774C4.79168 8.76724 5.0715 9.05066 5.41668 9.05066H10C10.3452 9.05066 10.625 8.76724 10.625 8.41774C10.625 8.06817 10.3452 7.7848 10 7.7848H5.41668ZM4.79168 11.7932C4.79168 12.1428 5.0715 12.4262 5.41668 12.4262H10C10.3452 12.4262 10.625 12.1428 10.625 11.7932C10.625 11.4437 10.3452 11.1603 10 11.1603H5.41668C5.0715 11.1603 4.79168 11.4437 4.79168 11.7932ZM13.3333 4.40927C12.9882 4.40927 12.7083 4.69264 12.7083 5.04218C12.7083 5.39173 12.9882 5.6751 13.3333 5.6751H14.5833C14.9285 5.6751 15.2083 5.39173 15.2083 5.04218C15.2083 4.69264 14.9285 4.40927 14.5833 4.40927H13.3333ZM12.7083 8.41774C12.7083 8.76724 12.9882 9.05066 13.3333 9.05066H14.5833C14.9285 9.05066 15.2083 8.76724 15.2083 8.41774C15.2083 8.06817 14.9285 7.7848 14.5833 7.7848H13.3333C12.9882 7.7848 12.7083 8.06817 12.7083 8.41774ZM13.3333 11.1603C12.9882 11.1603 12.7083 11.4437 12.7083 11.7932C12.7083 12.1428 12.9882 12.4262 13.3333 12.4262H14.5833C14.9285 12.4262 15.2083 12.1428 15.2083 11.7932C15.2083 11.4437 14.9285 11.1603 14.5833 11.1603H13.3333Z" />
                            </svg>
                        </span>
                        <span class="text">Request Withdrawal</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a asp-page="CreateWorkShop">
                        <span class="icon">
                            <svg width="16" height="16" fill="currentColor" class="bi bi-cast" viewBox="0 0 16 16">
                                <path d="m7.646 9.354-3.792 3.792a.5.5 0 0 0 .353.854h7.586a.5.5 0 0 0 .354-.854L8.354 9.354a.5.5 0 0 0-.708 0" />
                                <path d="M11.414 11H14.5a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.5-.5h-13a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .5.5h3.086l-1 1H1.5A1.5 1.5 0 0 1 0 10.5v-7A1.5 1.5 0 0 1 1.5 2h13A1.5 1.5 0 0 1 16 3.5v7a1.5 1.5 0 0 1-1.5 1.5h-2.086z" />
                            </svg>
                        </span>
                        <span class="text">Create Your WorkShop</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a asp-page="CreateSchedule">
                        <span class="icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-calendar-event" viewBox="0 0 16 16">
                                <path d="M11 6.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5z" />
                                <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5M1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4z" />
                            </svg>
                        </span>
                        <span class="text">Create Your Schedule</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a asp-page="AttendancePage">
                        <span class="icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-calendar-check" viewBox="0 0 16 16">
                                <path d="M10.854 7.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 9.793l2.646-2.647a.5.5 0 0 1 .708 0" />
                                <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5M1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4z" />
                            </svg>
                        </span>
                        <span class="text">Attendance</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a asp-page="GradePage">
                        <span class="icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16">
                                <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5z" />
                                <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708" />
                            </svg>
                        </span>
                        <span class="text">Grading Page</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a asp-page="AddCouponPage">
                        <span class="icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-receipt" viewBox="0 0 16 16">
                                <path d="M1.92.506a.5.5 0 0 1 .434.14L3 1.293l.646-.647a.5.5 0 0 1 .708 0L5 1.293l.646-.647a.5.5 0 0 1 .708 0L7 1.293l.646-.647a.5.5 0 0 1 .708 0L9 1.293l.646-.647a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .801.13l.5 1A.5.5 0 0 1 15 2v12a.5.5 0 0 1-.053.224l-.5 1a.5.5 0 0 1-.8.13L13 14.707l-.646.647a.5.5 0 0 1-.708 0L11 14.707l-.646.647a.5.5 0 0 1-.708 0L9 14.707l-.646.647a.5.5 0 0 1-.708 0L7 14.707l-.646.647a.5.5 0 0 1-.708 0L5 14.707l-.646.647a.5.5 0 0 1-.708 0L3 14.707l-.646.647a.5.5 0 0 1-.801-.13l-.5-1A.5.5 0 0 1 1 14V2a.5.5 0 0 1 .053-.224l.5-1a.5.5 0 0 1 .367-.27m.217 1.338L2 2.118v11.764l.137.274.51-.51a.5.5 0 0 1 .707 0l.646.647.646-.646a.5.5 0 0 1 .708 0l.646.646.646-.646a.5.5 0 0 1 .708 0l.646.646.646-.646a.5.5 0 0 1 .708 0l.646.646.646-.646a.5.5 0 0 1 .708 0l.646.646.646-.646a.5.5 0 0 1 .708 0l.509.509.137-.274V2.118l-.137-.274-.51.51a.5.5 0 0 1-.707 0L12 1.707l-.646.647a.5.5 0 0 1-.708 0L10 1.707l-.646.647a.5.5 0 0 1-.708 0L8 1.707l-.646.647a.5.5 0 0 1-.708 0L6 1.707l-.646.647a.5.5 0 0 1-.708 0L4 1.707l-.646.647a.5.5 0 0 1-.708 0z" />
                                <path d="M3 4.5a.5.5 0 0 1 .5-.5h6a.5.5 0 1 1 0 1h-6a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 1 1 0 1h-6a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 1 1 0 1h-6a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5m8-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5" />
                            </svg>
                        </span>
                        <span class="text">Add Coupon</span>
                    </a>
                </li>
                <span class="divider"><hr /></span>
                <li class="nav-item">
                    <a href="/Index">
                        <span class="icon">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M14.9211 10.1294C15.1652 9.88534 15.1652 9.48967 14.9211 9.24559L10.7544 5.0789C10.5103 4.83482 10.1147 4.83482 9.87057 5.0789C9.62649 5.32297 9.62649 5.71871 9.87057 5.96278L12.9702 9.06251H1.97916C1.63398 9.06251 1.35416 9.34234 1.35416 9.68751C1.35416 10.0327 1.63398 10.3125 1.97916 10.3125H12.9702L9.87057 13.4123C9.62649 13.6563 9.62649 14.052 9.87057 14.2961C10.1147 14.5402 10.5103 14.5402 10.7544 14.2961L14.9211 10.1294Z" />
                                <path d="M11.6383 15.18L15.805 11.0133C16.5373 10.2811 16.5373 9.09391 15.805 8.36166L11.6383 4.195C11.2722 3.82888 10.7923 3.64582 10.3125 3.64582V3.02082C10.3125 2.10035 11.0587 1.35416 11.9792 1.35416H16.9792C17.8997 1.35416 18.6458 2.10035 18.6458 3.02082V16.3542C18.6458 17.2747 17.8997 18.0208 16.9792 18.0208H11.9792C11.0587 18.0208 10.3125 17.2747 10.3125 16.3542V15.7292C10.7923 15.7292 11.2722 15.5461 11.6383 15.18Z" />
                            </svg>
                        </span>
                        <span class="text">Back Home</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>
    <div class="overlay"></div>
    <!-- ======== sidebar-nav end =========== -->
    <!-- ======== main-wrapper start =========== -->
    <main class="main-wrapper">
        <!-- ========== header start ========== -->
        <header class="header">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-5 col-md-5 col-6">
                        <div class="header-left d-flex align-items-center">
                            <div class="menu-toggle-btn mr-15">
                                <button id="menu-toggle" class="main-btn primary-btn btn-hover">
                                    <i class="lni lni-chevron-left me-2"></i> Menu
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-7 col-md-7 col-6">
                        <div class="header-right">
                            <!-- notification start -->
                            <div class="notification-box ml-15 d-none d-md-flex">
                                <button class="dropdown-toggle position-relative" type="button" id="notificationDropdown"
                                        data-bs-toggle="dropdown" aria-expanded="false">
                                    <!-- Icon chuông -->
                                    <svg width="22" height="22" viewBox="0 0 22 22" fill="none"
                                         xmlns="http://www.w3.org/2000/svg">
                                        <path d="M11 20.1667C9.88317 20.1667 8.88718 19.63 8.23901 18.7917H13.761C13.113 19.63 12.1169 20.1667 11 20.1667Z" />
                                        <path d="M10.1157 2.74999C10.1157 2.24374 10.5117 1.83333 11 1.83333C11.4883 1.83333 11.8842 2.24374 11.8842 2.74999V2.82604C14.3932 3.26245 16.3051 5.52474 16.3051 8.24999V14.287C16.3051 14.5301 16.3982 14.7633 16.564 14.9352L18.2029 16.6342C18.4814 16.9229 18.2842 17.4167 17.8903 17.4167H4.10961C3.71574 17.4167 3.5185 16.9229 3.797 16.6342L5.43589 14.9352C5.6017 14.7633 5.69485 14.5301 5.69485 14.287V8.24999C5.69485 5.52474 7.60672 3.26245 10.1157 2.82604V2.74999Z" />
                                    </svg>

                                    <!-- Dot hiển thị new -->
                                    <span id="notificationDot"
                                          class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle d-none">
                                    </span>
                                </button>

                                <!-- Dropdown danh sách thông báo -->
                                <ul class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="notificationDropdown" id="notificationList">
                                    <li class="dropdown-header fw-bold" id="notificationHeader">No Notifications</li>
                                    <li><hr class="dropdown-divider"></li>
                                    <!-- Thông báo render động -->
                                </ul>
                            </div>
                            <!-- notification end -->
                            <!-- profile start -->
                            <div class="profile-box ml-15">
                                <button class="dropdown-toggle bg-transparent border-0" type="button" id="profile"
                                        data-bs-toggle="dropdown" aria-expanded="false">
                                    <div class="profile-info">
                                        <div class="info">
                                            <div class="image">
                                                <img src="~/images/fav_icon.png" alt="">
                                            </div>
                                            <div>
                                                <p>Mentor</p>
                                            </div>
                                        </div>
                                    </div>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profile">
                                    <li class="divider"></li>
                                    <li>
                                        <a asp-page="/Logout"> <i class="lni lni-exit"></i> Logout </a>
                                    </li>
                                </ul>
                            </div>
                            <!-- profile end -->
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <!-- ========== header end ========== -->
        <!-- ========== section start ========== -->
        <section class="section">
            <div class="container-fluid">
                @RenderBody()
                @Html.Partial("_Notification")
            </div>
            <!-- end container -->
        </section>
        <!-- ========== section end ========== -->
    </main>
    <!-- ======== main-wrapper end =========== -->
    <!-- ========= All Javascript files linkup ======== -->
    <script src=@Url.Content("~/MentorAssets/js/bootstrap.bundle.min.js")></script>
    <script src=@Url.Content("~/MentorAssets/js/Chart.min.js")></script>
    <script src=@Url.Content("~/MentorAssets/js/dynamic-pie-chart.js")></script>
    <script src=@Url.Content("~/MentorAssets/js/moment.min.js")></script>
    <script src=@Url.Content("~/MentorAssets/js/polyfill.js")></script>
    <script src=@Url.Content("~/MentorAssets/js/main.js")></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
        const apiBaseUrl = "@BaseUrl";   // từ cấu hình
        const hubUrl = "@HubUrl";        // từ cấu hình
        const userId = "@(userId?.ToString() ?? "")"; // từ claim

        // Render 1 item notification
        function renderNotificationItem(notification, isNew = false) {
            return `
            <li class="notification-item ${isNew ? 'new' : ''} px-3 py-2 border-bottom">
                <div class="message fw-medium">
                    ${notification.message}
                    ${isNew ? '<span class="badge bg-success ms-2">New</span>' : ''}
                </div>
                <div class="time text-muted small text-end mt-1">
                    ${new Date(notification.createdAt).toLocaleString()}
                </div>
            </li>
            `;
        }

        // Cập nhật số lượng vào header
        function updateHeader() {
            const count = document.querySelectorAll("#notificationList .notification-item").length;
            const header = document.getElementById("notificationHeader");
            header.innerText = count > 0 ? `${count} Notifications` : "No Notifications";
        }

        // Load khi mở trang
                async function loadNotifications() {
            if (!userId) return;

            try {
                // 👉 Lấy token từ cookie
                const token = getCookie("AccessToken");
                if (!token) {
                    console.warn("⚠️ No access token found in cookies");
                    return;
                }

                const response = await fetch(`${apiBaseUrl}/Notification/get-by-user/${userId}`, {
                    headers: {
                        "Authorization": `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error("Failed to fetch notifications");
                let notifications = await response.json();

                // 👉 Sắp xếp mới nhất trước
                notifications.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                const list = document.getElementById("notificationList");
                list.innerHTML = `
                    <li class="dropdown-header fw-bold" id="notificationHeader">
                        ${notifications.length > 0 ? `${notifications.length} Notifications` : "No Notifications"}
                    </li>
                    <li><hr class="dropdown-divider"></li>
                `;

                // 👉 append lần lượt theo đúng thứ tự sau khi sort
                notifications.forEach(noti => {
                    list.insertAdjacentHTML("beforeend", renderNotificationItem(noti, false));
                });

                // ❌ Dot KHÔNG tự bật khi load cũ
                const dot = document.getElementById("notificationDot");
                if (dot) dot.classList.add("d-none");

            } catch (err) {
                console.error("❌ Error loading notifications:", err);
            }
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(";").shift();
        }

        // Khi click dropdown → reset dot + clear NEW
        document.getElementById("notificationDropdown")?.addEventListener("click", () => {
            clearNewBadges();
        });

        function clearNewBadges() {
            const dot = document.getElementById("notificationDot");
            if (dot) dot.classList.add("d-none"); // ẩn dot

            // Xóa badge "New"
            document.querySelectorAll("#notificationList .notification-item .badge").forEach(b => b.remove());

            updateHeader();
        }

        // ---- SignalR ----
        if (!window.signalRConnection) {
            window.signalRConnection = new signalR.HubConnectionBuilder()
                .withUrl(`${hubUrl}/postHub?UserId=${userId}`)
                .withAutomaticReconnect()
                .build();

            window.signalRConnection.on("ReceiveNotification", (notification) => {
                if (typeof notification === "string") {
                    try { notification = JSON.parse(notification); } catch { return; }
                }

                const list = document.getElementById("notificationList");
                if (!list) return;

                // ✅ Chỉ bật dot khi có thông báo mới
                const dot = document.getElementById("notificationDot");
                if (dot) dot.classList.remove("d-none");

                // 👉 Thêm notification mới ngay sau header
                const divider = list.querySelector(".dropdown-divider");
                divider.insertAdjacentHTML("afterend", renderNotificationItem(notification, true));

                updateHeader();
            });

            window.signalRConnection.start()
                .then(() => console.log("✅ SignalR connected"))
                .catch(err => console.error("❌ SignalR error:", err));
        }

        // Load lần đầu
        loadNotifications();
    </script>


    <style>
        .notification-item {
            list-style: none;
            border-bottom: 1px solid #eee;
        }

        .notification-box {
            display: flex;
            flex-direction: column; /* sắp xếp dọc */
            padding: 10px 15px;
        }

            .notification-box .message {
                font-size: 14px;
                font-weight: 500;
                color: #333;
                text-align: left; /* bên trái */
            }

            .notification-box .time {
                font-size: 12px;
                color: #888;
                text-align: right; /* bên phải */
                margin-top: 4px;
            }

        .notification-item.new .message {
            font-weight: bold;
            color: #000;
        }

        .notification-item:hover {
            background: #f5f7fa; /* hover hiệu ứng */
            cursor: pointer;
        }
    </style>
    @RenderSection("Scripts", required: false)
</body>
</html>
