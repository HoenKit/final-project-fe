﻿@using System.IdentityModel.Tokens.Jwt
@using System.Security.Claims
@using final_project_fe.Utils
@using Microsoft.Extensions.Options
@inject IOptions<ApiSettings> ApiSettings
@inject IOptions<SignalrSetting> SignalrSetting

@{
	var roles = new List<string>();
	var token = Context.Request.Cookies["AccessToken"];
	bool isAuthenticated = !string.IsNullOrEmpty(token);
	Guid? userId = null;
	var BaseUrl = ApiSettings.Value.BaseUrl;
	var HubUrl = SignalrSetting.Value.HubUrl;

	JwtSecurityToken jwtToken = null;

	if (!string.IsNullOrEmpty(token))
	{
		var handler = new JwtSecurityTokenHandler();
		jwtToken = handler.ReadJwtToken(token);
		roles = jwtToken.Claims
					.Where(c => c.Type == ClaimTypes.Role || c.Type == "role")
					.Select(c => c.Value)
					.ToList();

		var userIdClaim = jwtToken.Claims.FirstOrDefault(c => c.Type == ClaimTypes.NameIdentifier);
		if (userIdClaim != null && Guid.TryParse(userIdClaim.Value, out var parsedId))
		{
			userId = parsedId;
		}
	}

	bool isMentor = roles.Contains("Mentor");
	bool isUser = roles.Contains("User");
	bool isAdmin = roles.Contains("Admin");
}
<!DOCTYPE html>
<html lang="en">
<head>
@*     <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
	<link rel="icon" href="~/images/fav.png" type="image/png" sizes="16x16">

	<link rel="stylesheet" href="~/css/main.min.css">
	<link rel="stylesheet" href="~/css/style.css">
	<link rel="stylesheet" href="~/css/color.css">
	<link rel="stylesheet" href="~/css/responsive.css">
	<link rel="stylesheet" href="~/css/strip.css">
 *@

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>@ViewData["Title"]</title>
	<link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
	<link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
	<link rel="icon" type="image/x-icon" href="~/images/fav_icon.png" />
	<link rel="stylesheet" href="~/css/main.min.css">
	<link rel="stylesheet" href="~/css/style.css">
	<link rel="stylesheet" href="~/css/color.css">
	<link rel="stylesheet" href="~/css/responsive.css">
	@* <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet"> *@
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
	<style>
		ul, ol {
			list-style: none;
			padding-left: 0;
		}

		.user-img {
			position: relative;
			display: inline-block;
			cursor: pointer;
		}

			.user-img img {
				width: 40px;
				height: 40px;
				border-radius: 50%;
				border: 2px solid #e1e8ed;
			}

		.custom-user-menu {
			position: absolute;
			top: 100%;
			right: 0;
			background: white;
			min-width: 200px;
			border-radius: 8px;
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
			border: 1px solid #e1e8ed;
			opacity: 0;
			visibility: hidden;
			transform: translateY(-10px);
			transition: all 0.3s ease;
			z-index: 1000;
			margin-top: 8px;
			/* Đảm bảo menu không bị overflow hidden */
			overflow: visible;
		}

			.custom-user-menu.show {
				opacity: 1;
				visibility: visible;
				transform: translateY(0);
			}

			.custom-user-menu::before {
				content: '';
				position: absolute;
				top: -8px;
				right: 15px;
				width: 0;
				height: 0;
				border-left: 8px solid transparent;
				border-right: 8px solid transparent;
				border-bottom: 8px solid white;
			}

			.custom-user-menu a {
				display: flex;
				align-items: center;
				padding: 12px 16px;
				color: #333;
				text-decoration: none;
				font-size: 14px;
				transition: background-color 0.2s ease;
				border-bottom: 1px solid #f0f0f0;
				/* Đảm bảo link có thể click */
				pointer-events: auto;
				position: relative;
				z-index: 1001;
			}

				.custom-user-menu a:last-child {
					border-bottom: none;
					border-radius: 0 0 8px 8px;
				}

				.custom-user-menu a:first-child {
					border-radius: 8px 8px 0 0;
				}

				.custom-user-menu a:hover {
					background-color: #f8f9fa;
					color: #007bff;
				}

				.custom-user-menu a i {
					margin-right: 10px;
					width: 16px;
					text-align: center;
					color: #666;
				}

				.custom-user-menu a:hover i {
					color: #007bff;
				}

		.badge-new {
			background-color: green;
			color: white;
			font-size: 10px;
			font-weight: bold;
			padding: 2px 4px;
			border-radius: 4px;
			margin-left: 6px;
		}
	</style>
</head>
<body>
	<header>
		<div class="topbar">
			<div class="logo">
				<a style="width:85%; margin-bottom:7%" title="" asp-page="/Index"><img src="~/images/Logoda.png" alt=""></a>
			</div>

			<div class="top-area">
				<ul class="main-menu">

					<li>
						<a asp-area="" asp-page="/Index" title="">Home</a>
					</li>
					<li>
						<a asp-page="/Mentor/MentorPage/Index" title="">Course</a>
						@* <ul>
							<li>
								<a class="nav-link text-dark" asp-area="" asp-page="/PointTransaction">Buy Point</a>
							</li>
							<li>
								<a class="nav-link text-dark" asp-area="" asp-page="/PurchaseHistory">Purchase History</a>
							</li>
							<li>
								<a class="nav-link text-dark" asp-area="" asp-page="/TransactionHistory">Transaction History</a>
							</li>
							<li>
								<a class="nav-link text-dark" asp-area="" asp-page="/Privacy">Privacy</a>
							</li>
							<li>
								<a class="nav-link text-dark" asp-area="" asp-page="/ErrorPage">404</a>
							</li>
						</ul> *@
					</li>
					@if (isMentor)
					{
						<li>
							<a asp-page="/Mentor/MentorPage/Dashboard">Mentor Page</a>
						</li>
					}
					@if (isAdmin)
					{
						<li style="all: unset; list-style: none; padding: 0; margin: 0;">
							<a asp-page="/Admin/Dashboard/Index">Admin Page</a>
						</li>
					}
					@if (isAuthenticated)
					{
						@if (!isAdmin)
						{
							<li>
								<a asp-page="/UserPage">My page</a>
							</li>
							<li style="all: unset; list-style: none; padding: 0; margin: 0;">
								<a asp-page="/CourseRecommend">Recommend Course</a>
							</li>
						}
					}
				</ul>
									@if (isAuthenticated)
				{
					<ul class="setting-area">

						<li id="pointDisplay">
							<a href="#" title="Your Points" data-ripple="">
								<span id="userPointBadge" style="
							display: inline-flex;
							align-items: center;
							justify-content: center;
							margin-left: 5px;
							background-color: #ff9800;
							color: #fff;
							font-size: 13px;
							font-weight: bold;
							padding: 2px 10px;
							border-radius: 20px;
							min-width: 40px;
							text-align: center;
							line-height: 1.2;
							margin-bottom: -13px;
								">0</span>
							</a>
						</li>
						@* <li><a href="newsfeed.html" title="Home" data-ripple=""><i class="ti-home"></i></a></li> *@
						<li id="notificationDropdown">
							<a href="#" title="Notification" data-ripple="">
								<i class="ti-bell"></i><span id="notificationCount">0</span>
							</a>
							<div class="dropdowns">
								<span id="notificationHeader">No New Notifications</span>
								<ul class="drops-menu" id="notificationList">
									<!-- JS sẽ render -->
								</ul>
								<a href="/notifications" title="" class="more-mesg">view more</a>
							</div>
						</li>
					</ul>
				}
				<div class="user-img" id="userImg">
					<img src="~/images/fav_icon.png" alt="">
					<div class="custom-user-menu" id="userMenu">
						@if (isAuthenticated)
						{
							@* <text>
                            <a asp-page="#" id="userPointsLink">
                                <i class="bi bi-p-circle"></i>
                                <span id="userPoints">@userPoints.ToString("N0")</span>
                            </a>
                        </text> *@
							if (!isAdmin && !isMentor)
							{
								<text>
									<a asp-page="/MentorRegulations"><i class="bi bi-person-vcard"></i> Become a Mentor</a>
								</text>
							}
							<text>
								@if (!isAdmin)
								{
									<a asp-page="/UserProfile"><i class="ti-user"></i> View Profile</a>
									<a asp-page="/Chatting"><i class="bi bi-wechat"></i> Chatting</a>
									<a asp-page="/UserCourse"><i class="bi bi-book-half"></i> My Own Course</a>
								}
								<a asp-page="/Logout"><i class="bi bi-box-arrow-in-left" style="font-size: 115%;"></i> Logout</a>
							</text>
						}
						else
						{
							<text>
								<a asp-page="/Login"><i class="bi bi-box-arrow-in-right" style="font-size: 118%;"></i> Login</a>
								<a asp-page="/Register"><i class="bi bi-pencil-square"></i> Register</a>
							</text>
						}
					</div>
				</div>

				@* <span class="ti-menu main-menu" data-ripple=""></span> *@
			</div>
		</div><!-- topbar -->
		@* 	<div class="side-panel">
			<h4 class="panel-title">Account Manage</h4>
			<ul class="navbar-nav flex-grow-1">
				@if (isAuthenticated)
				{

					@if (!isMentor)
					{
						<li style="padding-bottom: 4%;">
							<i class="bi bi-person-vcard"></i>
							<a asp-page="/MentorRegulations">Become a Mentor</a>
						</li>
					}
					<li>
						<i style="font-size: 115%;" class="bi bi-box-arrow-in-left"></i>
						<a asp-page="/Logout">Logout</a>
					</li>
				}
				else
				{
					<li style="padding-bottom: 4%;">
						<i style="font-size:118%;" class="bi bi-box-arrow-in-right"></i>
						<a asp-page="/Login">Login</a>
					</li>
					<li style="padding-left: 2%;">
						<i class="bi bi-pencil-square"></i>
						<a asp-page="/Register">Register</a>
					</li>
				}
			</ul>
		</div><!-- side panel --> *@
	</header>

    <div class="">
        <main role="main" class="pb-3">
            @RenderBody()
			@Html.Partial("_Notification")
        </main>
    </div>

    <footer class="border-top footer text-muted">
		<div class="container">
			<div class="row">
				<div class="col-lg-4 col-md-4">
					<div class="widget">
						<div class="foot-logo">
							<div class="logo">
								<a style="width:85%; margin-bottom:7%" title="" href="/Index">
									<img src="~/images/Logoda.png" alt="">
								</a>
							</div>
							<p>
								The trio took this simple idea and built it into the world’s leading carpooling platform.
							</p>
						</div>
						<ul class="location">
							<li>
								<i class="ti-map-alt"></i>
								<p>33 new montgomery st.750 san francisco, CA USA 94105.</p>
							</li>
							<li>
								<i class="ti-mobile"></i>
								<p>+1-56-346 345</p>
							</li>
						</ul>
					</div>
				</div>
				<div class="col-lg-2 col-md-4">
					<div class="widget">
						<div class="widget-title"><h4>follow</h4></div>
						<ul class="list-style">
							<li><i class="fa fa-facebook-square"></i> <a href="https://web.facebook.com/shopcircut/" title="">facebook</a></li>
							<li><i class="fa fa-twitter-square"></i><a href="https://twitter.com/login?lang=en" title="">twitter</a></li>
							<li><i class="fa fa-instagram"></i><a href="https://www.instagram.com/?hl=en" title="">instagram</a></li>
							<li><i class="fa fa-google-plus-square"></i> <a href="https://plus.google.com/discover" title="">Google+</a></li>
							<li><i class="fa fa-pinterest-square"></i> <a href="https://www.pinterest.com/" title="">Pintrest</a></li>
						</ul>
					</div>
				</div>
				<div class="col-lg-2 col-md-4">
					<div class="widget">
						<div class="widget-title"><h4>Navigate</h4></div>
						<ul class="list-style">
							<li><a href="#" title="">about us</a></li>
							<li><a href="#" title="">contact us</a></li>
							<li><a href="#" title="">terms & Conditions</a></li>
							<li><a href="#" title="">RSS syndication</a></li>
							<li><a href="#" title="">Sitemap</a></li>
						</ul>
					</div>
				</div>
				<div class="col-lg-2 col-md-4">
					<div class="widget">
						<div class="widget-title"><h4>useful links</h4></div>
						<ul class="list-style">
							<li><a href="#" title="">leasing</a></li>
							<li><a href="#" title="">submit route</a></li>
							<li><a href="#" title="">how does it work?</a></li>
							<li><a href="#" title="">agent listings</a></li>
							<li><a href="#" title="">view All</a></li>
						</ul>
					</div>
				</div>
				<div class="col-lg-2 col-md-4">
					<div class="widget">
						<div class="widget-title"><h4>download apps</h4></div>
						<ul class="colla-apps">
							<li><a href="https://play.google.com/store?hl=en" title=""><i class="fa fa-android"></i>android</a></li>
							<li><a href="https://www.apple.com/lae/ios/app-store/" title=""><i class="ti-apple"></i>iPhone</a></li>
							<li><a href="https://www.microsoft.com/store/apps" title=""><i class="fa fa-windows"></i>Windows</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
    </footer>

    @* <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script> *@

	<script src="@Url.Content("~/js/main.min.js")"></script>
	<script src="@Url.Content("~/js/script.js")"></script>
	<script src="@Url.Content("~/js/strip.pkgd.min.js")"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	@* <script src="~/js/map-init.js"></script> *@
	@* <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA8c55_YHLvDHGACkQscgbGLtLRdxBDCfI"></script> *@
	<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
	<script>
				document.addEventListener('DOMContentLoaded', function () {
			const hasToken = document.cookie.includes('AccessToken=');

			if (!hasToken) {
				sessionStorage.removeItem('courseRecommendLoadingShown');
			}
		});

		// Fixed JavaScript cho user menu
		const userImg = document.getElementById('userImg');
		const userMenu = document.getElementById('userMenu');

		// Toggle menu khi click vào ảnh user (không phải vào dropdown menu)
		userImg.addEventListener('click', function (e) {
			e.stopPropagation(); // Ngăn event bubble up

			// Nếu click vào link trong menu, không toggle menu
			if (e.target.closest('.custom-user-menu a')) {
				return;
			}

			// Nếu click vào ảnh hoặc vùng user-img (không phải menu), toggle menu
			if (e.target.closest('img') || (e.target === userImg && !e.target.closest('.custom-user-menu'))) {
				userMenu.classList.toggle('show');
			}
		});

		// Click bên ngoài sẽ đóng menu
		document.addEventListener('click', function (event) {
			// Chỉ đóng menu nếu click bên ngoài toàn bộ user-img container
			if (!userImg.contains(event.target)) {
				userMenu.classList.remove('show');
			}
		});

		// Đảm bảo các link trong menu hoạt động bình thường
		document.querySelectorAll('.custom-user-menu a').forEach(link => {
			link.addEventListener('click', function (e) {
				e.stopPropagation(); // Ngăn event bubble up
				// Menu sẽ tự đóng khi navigate sang trang mới
				// Không cần gọi userMenu.classList.remove('show') ở đây
			});
		});
	</script>

	<script>
		const apiBaseUrl = "@BaseUrl";   // từ ApiSettings
		const hubUrl = "@HubUrl";       // từ SignalrSetting
		const userId = "@(userId?.ToString() ?? "")"; // từ JWT claim

		// Render 1 item notification
		function renderNotificationItem(notification, isNew = false) {
			return `
				<li data-id="${notification.notificationId}">
					<a href="/notifications" title="">
						<div class="mesg-meta">
							<span>${notification.message}</span>
							<i>${new Date(notification.createdAt).toLocaleString()}</i>
						</div>
					</a>
					<span class="tag ${isNew ? "green" : ""}">${isNew ? "New" : ""}</span>
				</li>
			`;
		}


		// Load notification khi vừa load trang (chỉ render, không cộng count)
		async function loadNotifications() {
			if (!userId) return; // chưa login thì thoát
			try {
				console.log("🔄 Fetching notifications for user:", userId);

				const response = await fetch(`${apiBaseUrl}/Notification/get-by-user/${userId}`);
				if (!response.ok) throw new Error("Failed to fetch notifications");
				const notifications = await response.json();

				console.log("📥 Notifications loaded from API:", notifications);

				const list = document.getElementById("notificationList");
				if (!list) return; // tránh lỗi nếu element chưa có
				list.innerHTML = "";

				notifications.forEach(noti => {
					list.insertAdjacentHTML("beforeend", renderNotificationItem(noti, false));
				});

				// Count = 0 khi mới load
				document.getElementById("notificationCount").innerText = 0;
				document.getElementById("notificationHeader").innerText =
					notifications.length > 0
						? `${notifications.length} Notifications`
						: "No Notifications";

			} catch (err) {
				console.error("❌ Error loading notifications:", err);
			}
		}

		// Khi mở dropdown thì reset badge
		const dropdown = document.getElementById("notificationDropdown");
		if (dropdown) {
			dropdown.addEventListener("click", () => {
				console.log("📌 Dropdown clicked → Reset badge count + clear NEW");
				clearNewBadges();
			});
		}

		// ---- SignalR connection ----
		if (!window.signalRConnection) {
			console.log("🚀 Creating new SignalR connection...");

		window.signalRConnection = new signalR.HubConnectionBuilder()
			.withUrl(`${hubUrl}/postHub?UserId=${userId}`)
			.withAutomaticReconnect()
			.build();

			window.signalRConnection.on("ReceiveNotification", (notification) => {
			console.log("📡 Raw SignalR data received:", notification);

			// Nếu notification là string thì parse JSON
			if (typeof notification === "string") {
				try {
					notification = JSON.parse(notification);
					console.log("✅ Parsed notification object:", notification);
				} catch (e) {
					console.error("❌ Failed to parse notification JSON:", e);
					return; // dừng luôn vì không parse được
				}
			}

			if (!notification || !notification.notificationId) {
				console.warn("⚠️ Notification object invalid:", notification);
				return;
			}

			const list = document.getElementById("notificationList");
			if (!list) {
				console.warn("⚠️ No #notificationList element found, skipping render");
				return;
			}

			// tăng số lượng chỉ khi có SignalR push
			const countEl = document.getElementById("notificationCount");
			let count = parseInt(countEl.innerText) || 0;
			count++;
			countEl.innerText = count;
			console.log(`🔔 Notification count updated: ${count}`);

			// thêm vào đầu danh sách
			list.insertAdjacentHTML("afterbegin", renderNotificationItem(notification, true));
			console.log("✅ Notification rendered at top of list");

			// cập nhật header
		const header = document.getElementById("notificationHeader");
		header.innerText = `${list.children.length} Notifications`;
		});

			window.signalRConnection.start()
				.then(() => console.log("✅ SignalR connected (only once)"))
				.catch(err => console.error("❌ SignalR error:", err));
		} else {
			console.log("🔄 Using existing SignalR connection");
		}
				function clearNewBadges() {
			// reset số đếm
			document.getElementById("notificationCount").innerText = 0;

			// xóa text "New" + class "green"
			document.querySelectorAll("#notificationList li .tag").forEach(tag => {
				tag.innerText = "";
				tag.classList.remove("green");
			});

			// cập nhật lại header: nếu còn item thì ghi tổng số, nếu rỗng thì "No Notifications"
			const list = document.getElementById("notificationList");
			const header = document.getElementById("notificationHeader");
			if (list && list.children.length > 0) {
				header.innerText = `Notifications`;
			} else {
				header.innerText = "No Notifications";
			}
		}
		// gọi khi load trang
		loadNotifications();
	</script>
	<script>
		document.addEventListener("DOMContentLoaded", function() {
			const userId = "@(userId?.ToString() ?? "")"; // lấy dynamic từ Razor
			const BaseUrl = "@BaseUrl";
			const apiUrl = `${BaseUrl}/User/GetUserById/${userId}`;

			fetch(apiUrl)
				.then(response => {
					if (!response.ok) throw new Error("Network response was not ok");
					return response.json();
				})
				.then(user => {
					const point = user.point ?? 0;
					document.getElementById("userPointBadge").textContent = point;
				})
				.catch(err => {
					console.error("Failed to fetch user point:", err);
					document.getElementById("userPointBadge").textContent = 0;
				});
		});
	</script>
    @await RenderSectionAsync("Scripts", required: false)
	

</body>
</html>