﻿@using System.IdentityModel.Tokens.Jwt
@using System.Security.Claims
@using Microsoft.Extensions.Options
@using final_project_fe.Utils
@inject IOptions<ApiSettings> ApiSettings
@{
	var roles = new List<string>();
	decimal userPoints = 0;
	var BaseUrl = ApiSettings.Value.BaseUrl;
	var token = Context.Request.Cookies["AccessToken"];
	bool isAuthenticated = !string.IsNullOrEmpty(token);
	if (!string.IsNullOrEmpty(token))
	{
		var handler = new JwtSecurityTokenHandler();
		var jwtToken = handler.ReadJwtToken(token);
		roles = jwtToken.Claims
					.Where(c => c.Type == ClaimTypes.Role || c.Type == "role")
					.Select(c => c.Value)
					.ToList();

		var pointsClaim = jwtToken.Claims.FirstOrDefault(c => c.Type == "points");
		if (pointsClaim != null)
		{
			var pointsValue = pointsClaim.Value;

			// Thêm debug này để xem chính xác
			var debugInfo = $"pointsValue: '{pointsValue}' | IsNull: {pointsValue == null} | IsEmpty: {string.IsNullOrEmpty(pointsValue)} | Length: {pointsValue?.Length ?? -1}";

			// Sau đó parse
			if (pointsValue != null && decimal.TryParse(pointsValue, out var points))
			{
				userPoints = points;
			}
		}
	}

	bool isMentor = roles.Contains("Mentor");
	bool isUser = roles.Contains("User");
	bool isAdmin = roles.Contains("Admin");
}
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>@ViewData["Title"]</title>
	<link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
	<link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
	<link rel="icon" type="image/x-icon" href="~/images/fav_icon.png" />
	<link rel="stylesheet" href="~/css/main.min.css">
	<link rel="stylesheet" href="~/css/style.css">
	<link rel="stylesheet" href="~/css/color.css">
	<link rel="stylesheet" href="~/css/responsive.css">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
	@* <link rel="stylesheet" href="~/final_project_fe.styles.css" asp-append-version="true" /> *@
	<style>
		ul, ol {
			list-style: none;
			padding-left: 0;
		}

		.user-img {
			position: relative;
			display: inline-block;
			cursor: pointer;
		}

			.user-img img {
				width: 40px;
				height: 40px;
				border-radius: 50%;
				border: 2px solid #e1e8ed;
			}

		.custom-user-menu {
			position: absolute;
			top: 100%;
			right: 0;
			background: white;
			min-width: 200px;
			border-radius: 8px;
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
			border: 1px solid #e1e8ed;
			opacity: 0;
			visibility: hidden;
			transform: translateY(-10px);
			transition: all 0.3s ease;
			z-index: 1000;
			margin-top: 8px;
			/* Đảm bảo menu không bị overflow hidden */
			overflow: visible;
		}

			.custom-user-menu.show {
				opacity: 1;
				visibility: visible;
				transform: translateY(0);
			}

			.custom-user-menu::before {
				content: '';
				position: absolute;
				top: -8px;
				right: 15px;
				width: 0;
				height: 0;
				border-left: 8px solid transparent;
				border-right: 8px solid transparent;
				border-bottom: 8px solid white;
			}

			.custom-user-menu a {
				display: flex;
				align-items: center;
				padding: 12px 16px;
				color: #333;
				text-decoration: none;
				font-size: 14px;
				transition: background-color 0.2s ease;
				border-bottom: 1px solid #f0f0f0;
				/* Đảm bảo link có thể click */
				pointer-events: auto;
				position: relative;
				z-index: 1001;
			}

				.custom-user-menu a:last-child {
					border-bottom: none;
					border-radius: 0 0 8px 8px;
				}

				.custom-user-menu a:first-child {
					border-radius: 8px 8px 0 0;
				}

				.custom-user-menu a:hover {
					background-color: #f8f9fa;
					color: #007bff;
				}

				.custom-user-menu a i {
					margin-right: 10px;
					width: 16px;
					text-align: center;
					color: #666;
				}

				.custom-user-menu a:hover i {
					color: #007bff;
				}
	</style>
</head>
<body>
	@*     <header>
        <nav class="navbar navbar-expand-sm navbar-toggleable-sm navbar-light bg-white border-bottom box-shadow mb-3">
            <div class="container">
                <a class="navbar-brand" asp-area="" asp-page="/Index">final_project_fe</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target=".navbar-collapse" aria-controls="navbarSupportedContent"
                        aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="navbar-collapse collapse d-sm-inline-flex justify-content-between">
                    <ul class="navbar-nav flex-grow-1">
                        <li class="nav-item">
                            <a class="nav-link text-dark" asp-area="" asp-page="/Index">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-dark" asp-area="" asp-page="/Privacy">Privacy</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header> *@
	<header>
		<div class="topbar">
			<div class="logo">
				<a style="width:85%; margin-bottom:7%" title="" asp-page="/Index"><img src="images/Logoda.png" alt=""></a>
			</div>

			<div class="top-area">
				<ul style="margin-bottom: -10%;" class="main-menu">

					<li>
						<a asp-area="" asp-page="/Index" title="">Home</a>
					</li>
					<li>
						<a asp-page="/Mentor/MentorPage/Index" title="">Course</a>
						@* <ul>
							<li>
								<a class="nav-link text-dark" asp-area="" asp-page="/PointTransaction">Buy Point</a>
							</li>
							<li>
								<a class="nav-link text-dark" asp-area="" asp-page="/PurchaseHistory">Purchase History</a>
							</li>
							<li>
								<a class="nav-link text-dark" asp-area="" asp-page="/TransactionHistory">Transaction History</a>
							</li>
							<li>
								<a class="nav-link text-dark" asp-area="" asp-page="/Privacy">Privacy</a>
							</li>
							<li>
								<a class="nav-link text-dark" asp-area="" asp-page="/ErrorPage">404</a>
							</li>
						</ul> *@
					</li>
					@if (isMentor)
					{
						<li>
							<a asp-page="/Mentor/MentorPage/Dashboard">Mentor Page</a>
						</li>
					}
					@if (isAdmin)
					{
						<li style="all: unset; list-style: none; padding: 0; margin: 0;">
							<a asp-page="/Admin/Dashboard/Index">Admin Page</a>
						</li>
					}
					@if (isAuthenticated)
					{
						@if (!isAdmin)
						{
							<li>
								<a asp-page="/UserPage">My page</a>
							</li>
							<li style="all: unset; list-style: none; padding: 0; margin: 0;">
								<a asp-page="/CourseRecommend">Recommend Course</a>
							</li>
						}
					}
				</ul>
				<ul style="margin-bottom: -3.5%;" class="setting-area">
					<li class="search-container">
						<a href="#" title="Search" data-ripple=""><i class="ti-search"></i></a>
						<div class="searched">
							<div class="form-search position-relative">
								<input type="text" id="searchInput" placeholder="Search Users, Courses, Posts">
								<button type="button" id="searchBtn" data-ripple><i class="ti-search"></i></button>

								<!-- Gợi ý hiển thị ngay bên dưới input -->
								<ul id="searchResults" class="list-group position-absolute w-100 mt-1 shadow"
									style="z-index: 999; max-height: 350px; overflow-y: auto;"></ul>
							</div>
						</div>
					</li>
					@* <li><a href="newsfeed.html" title="Home" data-ripple=""><i class="ti-home"></i></a></li> *@
					<li>
						<a href="#" title="Notification" data-ripple="">
							<i class="ti-bell"></i><span>20</span>
						</a>
						<div class="dropdowns">
							<span>4 New Notifications</span>
							<ul class="drops-menu">
								<li>
									<a href="notifications.html" title="">
										<img src="images/resources/thumb-1.jpg" alt="">
										<div class="mesg-meta">
											<h6>sarah Loren</h6>
											<span>Hi, how r u dear ...?</span>
											<i>2 min ago</i>
										</div>
									</a>
									<span class="tag green">New</span>
								</li>
								<li>
									<a href="notifications.html" title="">
										<img src="images/resources/thumb-2.jpg" alt="">
										<div class="mesg-meta">
											<h6>Jhon doe</h6>
											<span>Hi, how r u dear ...?</span>
											<i>2 min ago</i>
										</div>
									</a>
									<span class="tag red">Reply</span>
								</li>
								<li>
									<a href="notifications.html" title="">
										<img src="images/resources/thumb-3.jpg" alt="">
										<div class="mesg-meta">
											<h6>Andrew</h6>
											<span>Hi, how r u dear ...?</span>
											<i>2 min ago</i>
										</div>
									</a>
									<span class="tag blue">Unseen</span>
								</li>
								<li>
									<a href="notifications.html" title="">
										<img src="images/resources/thumb-4.jpg" alt="">
										<div class="mesg-meta">
											<h6>Tom cruse</h6>
											<span>Hi, how r u dear ...?</span>
											<i>2 min ago</i>
										</div>
									</a>
									<span class="tag">New</span>
								</li>
								<li>
									<a href="notifications.html" title="">
										<img src="images/resources/thumb-5.jpg" alt="">
										<div class="mesg-meta">
											<h6>Amy</h6>
											<span>Hi, how r u dear ...?</span>
											<i>2 min ago</i>
										</div>
									</a>
									<span class="tag">New</span>
								</li>
							</ul>
							<a href="notifications.html" title="" class="more-mesg">view more</a>
						</div>
					</li>
					<li>
						<a href="#" title="Languages" data-ripple=""><i class="fa fa-globe"></i></a>
						<div class="dropdowns languages">
							<a href="#" title=""><i class="ti-check"></i>English</a>
							<a href="#" title="">Vietnam</a>
						</div>
					</li>
				</ul>
				<div class="user-img" id="userImg">
					<img src="~/images/fav_icon.png" alt="">
					<div class="custom-user-menu" id="userMenu">
						@if (isAuthenticated)
						{
							@* <text>
                            <a asp-page="#" id="userPointsLink">
                                <i class="bi bi-p-circle"></i>
                                <span id="userPoints">@userPoints.ToString("N0")</span>
                            </a>
                        </text> *@
							if (!isAdmin && !isMentor)
							{
								<text>
									<a asp-page="/MentorRegulations"><i class="bi bi-person-vcard"></i> Become a Mentor</a>
								</text>
							}
							<text>
								@if (!isAdmin)
								{
									<a asp-page="/UserProfile"><i class="ti-user"></i> View Profile</a>
									<a asp-page="/Chatting"><i class="bi bi-wechat"></i> Chatting</a>
									<a asp-page="/UserCourse"><i class="bi bi-book-half"></i> My Own Course</a>
								}
								<a asp-page="/Logout"><i class="bi bi-box-arrow-in-left" style="font-size: 115%;"></i> Logout</a>
							</text>
						}
						else
						{
							<text>
								<a asp-page="/Login"><i class="bi bi-box-arrow-in-right" style="font-size: 118%;"></i> Login</a>
								<a asp-page="/Register"><i class="bi bi-pencil-square"></i> Register</a>
							</text>
						}
					</div>
				</div>

				@* <span class="ti-menu main-menu" data-ripple=""></span> *@
			</div>
		</div><!-- topbar -->
		@* 	<div class="side-panel">
			<h4 class="panel-title">Account Manage</h4>
			<ul class="navbar-nav flex-grow-1">
				@if (isAuthenticated)
				{

					@if (!isMentor)
					{
						<li style="padding-bottom: 4%;">
							<i class="bi bi-person-vcard"></i>
							<a asp-page="/MentorRegulations">Become a Mentor</a>
						</li>
					}
					<li>
						<i style="font-size: 115%;" class="bi bi-box-arrow-in-left"></i>
						<a asp-page="/Logout">Logout</a>
					</li>
				}
				else
				{
					<li style="padding-bottom: 4%;">
						<i style="font-size:118%;" class="bi bi-box-arrow-in-right"></i>
						<a asp-page="/Login">Login</a>
					</li>
					<li style="padding-left: 2%;">
						<i class="bi bi-pencil-square"></i>
						<a asp-page="/Register">Register</a>
					</li>
				}
			</ul>
		</div><!-- side panel --> *@
	</header>
		<!-- Post Detail Modal -->
		<div class="modal fade" id="postDetailModal" tabindex="-1" aria-labelledby="postDetailModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-xl" style="max-width: 50% !important;">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="postDetailModalLabel">Post Details</h5>
						@* <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> *@
					</div>
					<div class="modal-body" id="postModalBody">
						<div class="d-flex justify-content-center">
							<div class="spinner-border" role="status">
								<span class="visually-hidden">Loading...</span>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	<div class="">
		<main role="main" class="pb-3">
			@RenderBody()
			@Html.Partial("_Notification")
			@Html.Partial("_ConfirmDialog")
		</main>
	</div>

	<footer class="border-top footer text-muted">
		<div class="container">
			<div class="row">
				<div class="col-lg-4 col-md-4">
					<div class="widget">
						<div class="foot-logo">
							<div class="logo">
								<a style="width:85%; margin-bottom:7%" title="" asp-page="/Index"><img src="images/Logoda.png" alt=""></a>
							</div>
							<p>
								The trio took this simple idea and built it into the world’s leading carpooling platform.
							</p>
						</div>
						<ul class="location">
							<li>
								<i class="ti-map-alt"></i>
								<p>33 new montgomery st.750 san francisco, CA USA 94105.</p>
							</li>
							<li>
								<i class="ti-mobile"></i>
								<p>+1-56-346 345</p>
							</li>
						</ul>
					</div>
				</div>
				<div class="col-lg-2 col-md-4">
					<div class="widget">
						<div class="widget-title"><h4>follow</h4></div>
						<ul class="list-style">
							<li><i class="fa fa-facebook-square"></i> <a href="https://web.facebook.com/shopcircut/" title="">facebook</a></li>
							<li><i class="fa fa-twitter-square"></i><a href="https://twitter.com/login?lang=en" title="">twitter</a></li>
							<li><i class="fa fa-instagram"></i><a href="https://www.instagram.com/?hl=en" title="">instagram</a></li>
							<li><i class="fa fa-google-plus-square"></i> <a href="https://plus.google.com/discover" title="">Google+</a></li>
							<li><i class="fa fa-pinterest-square"></i> <a href="https://www.pinterest.com/" title="">Pintrest</a></li>
						</ul>
					</div>
				</div>
				<div class="col-lg-2 col-md-4">
					<div class="widget">
						<div class="widget-title"><h4>Navigate</h4></div>
						<ul class="list-style">
							<li><a href="#" title="">about us</a></li>
							<li><a href="#" title="">contact us</a></li>
							<li><a href="#" title="">terms & Conditions</a></li>
							<li><a href="#" title="">RSS syndication</a></li>
							<li><a href="#" title="">Sitemap</a></li>
						</ul>
					</div>
				</div>
				<div class="col-lg-2 col-md-4">
					<div class="widget">
						<div class="widget-title"><h4>useful links</h4></div>
						<ul class="list-style">
							<li><a href="#" title="">leasing</a></li>
							<li><a href="#" title="">submit route</a></li>
							<li><a href="#" title="">how does it work?</a></li>
							<li><a href="#" title="">agent listings</a></li>
							<li><a href="#" title="">view All</a></li>
						</ul>
					</div>
				</div>
				<div class="col-lg-2 col-md-4">
					<div class="widget">
						<div class="widget-title"><h4>download apps</h4></div>
						<ul class="colla-apps">
							<li><a href="https://play.google.com/store?hl=en" title=""><i class="fa fa-android"></i>android</a></li>
							<li><a href="https://www.apple.com/lae/ios/app-store/" title=""><i class="ti-apple"></i>iPhone</a></li>
							<li><a href="https://www.microsoft.com/store/apps" title=""><i class="fa fa-windows"></i>Windows</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</footer>

	<script src="~/lib/jquery/dist/jquery.min.js"></script>
	<script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
	<script src="~/js/site.js" asp-append-version="true"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

	@* <script data-cfasync="false" src="../../cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script> *@
	<script src="~/js/main.min.js"></script>
	<script src="~/js/script.js"></script>
	<script src="~/js/map-init.js"></script>
	@* <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA8c55_YHLvDHGACkQscgbGLtLRdxBDCfI"></script> *@
	<script>
		document.addEventListener('DOMContentLoaded', function () {
			const hasToken = document.cookie.includes('AccessToken=');

			if (!hasToken) {
				sessionStorage.removeItem('courseRecommendLoadingShown');
			}
		});
	</script>
	<script>
				document.addEventListener('DOMContentLoaded', function () {
			const hasToken = document.cookie.includes('AccessToken=');

			if (!hasToken) {
				sessionStorage.removeItem('courseRecommendLoadingShown');
			}
		});

		// Fixed JavaScript cho user menu
		const userImg = document.getElementById('userImg');
		const userMenu = document.getElementById('userMenu');

		// Toggle menu khi click vào ảnh user (không phải vào dropdown menu)
		userImg.addEventListener('click', function (e) {
			e.stopPropagation(); // Ngăn event bubble up

			// Nếu click vào link trong menu, không toggle menu
			if (e.target.closest('.custom-user-menu a')) {
				return;
			}

			// Nếu click vào ảnh hoặc vùng user-img (không phải menu), toggle menu
			if (e.target.closest('img') || (e.target === userImg && !e.target.closest('.custom-user-menu'))) {
				userMenu.classList.toggle('show');
			}
		});

		// Click bên ngoài sẽ đóng menu
		document.addEventListener('click', function (event) {
			// Chỉ đóng menu nếu click bên ngoài toàn bộ user-img container
			if (!userImg.contains(event.target)) {
				userMenu.classList.remove('show');
			}
		});

		// Đảm bảo các link trong menu hoạt động bình thường
		document.querySelectorAll('.custom-user-menu a').forEach(link => {
			link.addEventListener('click', function (e) {
				e.stopPropagation(); // Ngăn event bubble up
				// Menu sẽ tự đóng khi navigate sang trang mới
				// Không cần gọi userMenu.classList.remove('show') ở đây
			});
		});
	</script>
	<script>
		document.addEventListener("DOMContentLoaded", function () {
			const searchInput = document.getElementById("searchInput");
			const searchBtn = document.getElementById("searchBtn");
			const resultsContainer = document.getElementById("searchResults");
			let debounceTimer;

			const baseUrl = "@BaseUrl";

			async function doSearch(isSuggestion = false) {
				const term = searchInput.value.trim();
				if (!term) {
					resultsContainer.innerHTML = "";
					return;
				}

				try {
					const response = await fetch(`${baseUrl}/Post/search-all?searchTerm=${encodeURIComponent(term)}&searchType=all`);
					if (!response.ok) throw new Error("Search failed");
					const data = await response.json();

					let html = "";

					// Users
					if (data.users && data.users.length > 0) {
						html += `<li class="list-group-item fw-bold bg-light">Users</li>`;
						data.users.forEach(u => {
							html += `
								<li class="list-group-item search-item" data-type="user" data-id="${u.userId}">
									<i class="ti-user me-2"></i>
									${u.userMetaData?.firstName ?? ""} ${u.userMetaData?.lastName ?? ""}
									<small class="text-muted">(${u.email ?? ""})</small>
								</li>`;
						});
					}

					// Courses
					if (data.courses && data.courses.length > 0) {
						html += `<li class="list-group-item fw-bold bg-light">Courses</li>`;
						data.courses.forEach(c => {
							html += `
								<li class="list-group-item search-item" data-type="course" data-id="${c.courseId}">
									<i class="ti-book me-2"></i> ${c.courseName}
								</li>`;
						});
					}

					// Posts
					if (data.posts && data.posts.length > 0) {
						html += `<li class="list-group-item fw-bold bg-light">Posts</li>`;
						data.posts.forEach(p => {
							html += `
								<li class="list-group-item search-item" data-type="post" data-id="${p.postId}">
									<i class="ti-pencil-alt me-2"></i> ${p.title ?? "(No title)"}
								</li>`;
						});
					}

					resultsContainer.innerHTML = html || `<li class="list-group-item">No results found</li>`;

					// Gắn sự kiện click cho các item
					document.querySelectorAll(".search-item").forEach(item => {
						item.addEventListener("click", function () {
							const type = this.getAttribute("data-type");
							const id = this.getAttribute("data-id");

							if (type === "user") {
								// Nếu UserPage cũng theo query string thì đổi tương tự
								window.location.href = `/UserPage?userId=${id}`;
							} else if (type === "course") {
								window.location.href = `/Mentor/MentorPage/CourseDetail?courseId=${id}`;
							} else if (type === "post") {
								// Hiển thị modal với chi tiết bài post thay vì chuyển hướng
								showPostModal(id);
								// Đóng search results và clear input
								resultsContainer.innerHTML = "";
								searchInput.value = "";
							}
						});
					});
				} catch (err) {
					console.error(err);
					resultsContainer.innerHTML = `<li class="list-group-item text-danger">Error searching</li>`;
				}
			}

			// Hàm hiển thị modal chi tiết bài post
			async function showPostModal(postId) {
				const modal = new bootstrap.Modal(document.getElementById('postDetailModal'));
				const modalBody = document.getElementById('postModalBody');

				// Hiển thị loading
				modalBody.innerHTML = `
					<div class="d-flex justify-content-center">
						<div class="spinner-border" role="status">
							<span class="visually-hidden">Loading...</span>
						</div>
					</div>
				`;

				modal.show();

				try {
					// Tạm thời sử dụng dữ liệu từ trang hiện tại (nếu có)
					// Hoặc bạn có thể tạo API endpoint riêng để lấy chi tiết post

					// Tìm post trong trang hiện tại
					const postElements = document.querySelectorAll('[data-post-id="' + postId + '"]');
					let postFound = false;

					if (postElements.length > 0) {
						// Lấy thông tin từ DOM hiện tại
						const postContainer = postElements[0].closest('.card');
						if (postContainer) {
							const postClone = postContainer.cloneNode(true);

							// Loại bỏ các element không cần thiết trong modal
							const dropdownMenus = postClone.querySelectorAll('.dropdown');
							dropdownMenus.forEach(menu => menu.remove());

							// Loại bỏ form comment để tránh conflict
							const commentForms = postClone.querySelectorAll('.comment-form');
							commentForms.forEach(form => form.remove());

							modalBody.innerHTML = postClone.outerHTML;
							postFound = true;
						}
					}

					// Nếu không tìm thấy trong DOM, gọi API
					if (!postFound) {
						try {
							const response = await fetch(`${baseUrl}/api/Post/${postId}`);
							if (response.ok) {
								const postData = await response.json();
								displayPostFromAPI(postData);
							} else {
								throw new Error("Post not found in API");
							}
						} catch (apiError) {
							console.log("API call failed, showing basic error message");
							modalBody.innerHTML = `
								<div class="alert alert-warning">
									<i class="ti-info-alt me-2"></i>
									Post details are not available. The post might have been moved or deleted.
									<br><br>
									<small class="text-muted">Post ID: ${postId}</small>
								</div>
							`;
						}
					}

				} catch (error) {
					console.error('Error loading post details:', error);
					modalBody.innerHTML = `
						<div class="alert alert-danger">
							<i class="ti-alert-circle me-2"></i>
							Error loading post details. Please try again later.
						</div>
					`;
				}
			}

			// Hàm hiển thị post từ API data
			function displayPostFromAPI(post) {
				const modalBody = document.getElementById('postModalBody');

				// API trả về trực tiếp object post, không có comments và categories
				// Nếu cần comments và categories, cần gọi API riêng hoặc include trong response

				let postHtml = `
					<div class="card border-0">
						<div class="friend-info">
							<figure>
								<img src="${post.user?.userMetaData?.avatar || 'images/resources/friend-avatar9.jpg'}"
									 alt="User Avatar" style="width: 50px; height: 50px; border-radius: 50%;">
							</figure>

							<div class="post-meta">
								${post.category ? `<div class="mb-2"><span class="badge bg-primary text-white px-2 py-1 rounded-pill">#${post.category.title}</span></div>` : ''}
								<p style="font-size: 20px; font-weight: bold; color: black; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);">${post.title}</p>
							</div>

							<div class="friend-name">
								<ins>
									<a href="#" title="">
										${post.user?.userMetaData ? `${post.user.userMetaData.firstName} ${post.user.userMetaData.lastName}` : post.user?.email}
									</a>
								</ins>
								<span>${new Date(post.createAt).toLocaleDateString('vi-VN')} ${new Date(post.createAt).toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'})}</span>
							</div>

							<div class="post-meta">
								${post.postFiles && post.postFiles.length > 0 ?
									post.postFiles.map(file => {
										if (file.postFileType.toLowerCase() === 'image') {
											return `<img src="${file.fileUrl}" alt="Post Image" width="400" class="img-fluid mb-3">`;
										} else {
											return `<video width="100%" height="315" controls class="mb-3">
														<source src="${file.fileUrl}" type="video/mp4">
														Your browser does not support the video tag.
													</video>`;
										}
									}).join('') : ''
								}

								<div class="description">
									<p>${post.content}</p>
								</div>
							</div>

							<div class="comments-section">
								<h6 class="mb-3"><i class="ti-comment"></i> Comments</h6>
								${post.comments && post.comments.length > 0 ?
									post.comments.filter(c => !c.parentCommentId).map(comment => {
										const replies = post.comments.filter(r => r.parentCommentId === comment.commentId);
										return `
											<div class="comment mb-3">
												<div class="comet-avatar">
													<img src="${comment.user?.userMetaData?.avatar || 'images/resources/friend-avatar9.jpg'}" alt="User Avatar">
												</div>
												<div class="we-comment">
													<div class="coment-head">
														<h5><a href="#">${comment.user?.userMetaData ? `${comment.user.userMetaData.firstName} ${comment.user.userMetaData.lastName}` : comment.user?.email}</a></h5>
														<span>${new Date(comment.createAt).toLocaleDateString('vi-VN')} ${new Date(comment.createAt).toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'})}</span>
													</div>
													<p>${comment.content}</p>

												
												</div>
											</div>
										`;
									}).join('') :
									'<p class="text-muted">No comments yet.</p>'
								}
							</div>
						</div>
					</div>
				`;

				modalBody.innerHTML = postHtml;
			}

			// Nhấn nút hoặc Enter = thực hiện search
			searchBtn.addEventListener("click", () => doSearch(false));
			searchInput.addEventListener("keyup", function (e) {
				if (e.key === "Enter") doSearch(false);
			});

			// Suggestion khi gõ
			searchInput.addEventListener("input", function () {
				clearTimeout(debounceTimer);
				debounceTimer = setTimeout(() => {
					doSearch(true);
				}, 300); // debounce 300ms
			});
		});
	</script>
	@await RenderSectionAsync("Scripts", required: false)
</body>
</html>